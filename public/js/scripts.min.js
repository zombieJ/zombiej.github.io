!function(){var common={};common.getValueByPath=function(unit,path,defaultValue){if(null===unit||void 0===unit)throw"Unit or path can't be empty!";return""===path||null===path||void 0===path?unit:(path=path.replace(/\[(\d+)\]/g,".$1").replace(/^\./,"").split(/\./),$.each(path,function(i,path){return unit=unit[path],null===unit||void 0===unit?(unit=null,!1):void 0}),null===unit&&void 0!==defaultValue&&(unit=defaultValue),unit)},common.setValueByPath=function(unit,path,value){function _nextPath(array){var _key=path.slice(_start,_end);_inArray&&(_key=_key.slice(0,-1)),_unit[_key]||(array?_unit[_key]=[]:_unit[_key]={}),_unit=_unit[_key]}if(!unit||"string"!=typeof path||""===path)throw"Unit or path can't be empty!";for(var _inArray=!1,_end=0,_start=0,_unit=unit;_end<path.length;_end+=1)"."===path[_end]?(_nextPath(!1),_start=_end+1,_inArray=!1):"["===path[_end]&&(_nextPath(!0),_start=_end+1,_inArray=!0);return _unit[path.slice(_start,_inArray?-1:_end)]=value,unit},common.array={},common.array.find=function(val,list,path,findAll){path=path||"";var _list=$.grep(list,function(unit){return val===common.getValueByPath(unit,path)});return findAll?_list:0===_list.length?null:_list[0]},common.array.filter=function(val,list,path){return common.array.find(val,list,path,!0)},common.array.remove=function(val,list,path){path=path||"";for(var i=0;i<list.length;i+=1)common.getValueByPath(list[i],path)===val&&(list.splice(i,1),i-=1);return list},window.common?window.COMMON=common:window.common=common}(),function(){var app=angular.module("app",["ngRoute","configCtrl","blogCtrl","ui.bootstrap"]);app.config(function($routeProvider){$routeProvider.when("/home",{templateUrl:"partials/blog/list.html",controller:"listCtrl"}).when("/create",{templateUrl:"partials/blog/create.html",controller:"createCtrl"}).when("/edit/:createTime",{templateUrl:"partials/blog/create.html",controller:"createCtrl"}).when("/blog/:createTime",{templateUrl:"partials/blog/blog.html",controller:"blogCtrl"}).when("/config/common",{templateUrl:"partials/config/common.html",controller:"configCommonCtrl"}).otherwise({redirectTo:"/home"})}),app.controller("main",function($scope,Page,Blog,Config,Asset){window.Config=$scope.Config=Config,window.Page=$scope.Page=Page,window.Blog=$scope.Blog=Blog,window.Asset=$scope.Asset=Asset,$scope.$on("$routeChangeStart",function(event,next,current){Page.reset()}),$scope.rebuild=function(){Blog.rebuild().then(function(){$.dialog({title:"Success",content:"Rebuild successfully."})})}})}(),function(){angular.module("app").factory("Asset",function(File,$http,$q){var _list,Asset=function(){};return Asset.list=function(forceRefresh){return(!_list||forceRefresh)&&(_list=_list||[],File.list("data/assets").then(function(list){_list=list})),_list},Asset.upload=function(files){var _timestamp=+new Date,_promiseList=$.map(files,function(file){var _fileName=_timestamp+"_"+file.name;return File.copy(file.path,"data/assets/"+_fileName).then(function(){return{name:_fileName}})});return $q.all(_promiseList)},Asset["delete"]=function(item){var FS=require("fs");FS.unlinkSync(File.path("data/assets/"+item)),Asset.list(!0)},Asset})}(),function(){angular.module("app").factory("Blog",function(File,$http,$q){var _list,Blog=function(){};return Blog.snapshot=function(blog){var md=new Remarkable({html:!0,xhtmlOut:!1,breaks:!1,langPrefix:"language-",linkify:!1,typographer:!1}),$content=$(md.render(blog.content));return{title:blog.title,introduction:blog.introduction||$content.text().substr(0,200),tags:blog.tags,thumbnail:blog.thumbnail,createTime:blog.createTime}},Blog.list=function(forceRefresh){return(!_list||forceRefresh)&&(_list=_list||{},$http.get("data/list.json?_="+ +new Date).then(function(data){_list=data.data,_list.tags={},$.each(_list.articles,function(i,article){$.each(article.tags||[],function(j,tag){if(tag){var tagArticles=_list.tags[tag]=_list.tags[tag]||[];tagArticles.push(article)}})})})),_list},Blog.fetch=function(createTime){return File.read(File.path("data/articles/"+createTime+".json")).then(function(data){return JSON.parse(data)})},Blog.save=function(blog){var _path_article="data/articles/",_path_list="data/list.json",_deferred=$q.defer();return File.write(File.path(_path_article+blog.createTime+".json"),JSON.stringify(blog,null,"	")).then(function(){var data;File.read(File.path(_path_list)).then(function(_data){data=_data})["finally"](function(){var _list,_entity,i,_match;try{_list=JSON.parse(data)}catch(err){_list={}}for(_list.articles=_list.articles||[],_entity=Blog.snapshot(blog),_match=!1,i=0;i<_list.articles.length;i+=1)if(_list.articles[i].createTime===blog.createTime){_match=i;break}_match===!1?_list.articles.unshift(_entity):_list.articles[_match]=_entity,File.write(File.path(_path_list),JSON.stringify(_list,null,"	")).then(function(){_deferred.resolve(),Blog.list(!0)},function(err){_deferred.reject(err)})},function(err){_deferred.reject(err)})}),_deferred.promise},Blog["delete"]=function(createTime){var data,FS=require("fs"),_path_article="data/articles/",_path_list="data/list.json",_deferred=$q.defer();return FS.unlinkSync(File.path(_path_article+createTime+".json")),File.read(File.path(_path_list)).then(function(_data){data=_data})["finally"](function(){var _list;try{_list=JSON.parse(data)}catch(err){_list={}}common.array.remove(Number(createTime),_list.articles||[],"createTime"),File.write(File.path(_path_list),JSON.stringify(_list,null,"	")).then(function(){_deferred.resolve(),Blog.list(!0)},function(err){_deferred.reject(err)})}),_deferred.promise},Blog.rebuild=function(){var _deferred=$q.defer();return File.list(File.path("data/articles/")).then(function(list){var _list={articles:[]},_promiseList=$.map(list,function(file){return File.read(File.path("data/articles/"+file)).then(function(data){try{var _entity=Blog.snapshot(JSON.parse(data));_list.articles.push(_entity)}catch(err){console.error(err)}})});$q.all(_promiseList).then(function(){_list.articles.sort(function(a,b){return b.createTime-a.createTime}),File.write(File.path("data/list.json"),JSON.stringify(_list,null,"	"))["finally"](function(){_deferred.resolve(),Blog.list(!0)})})}),_deferred.promise},Blog})}(),function(){var _configPath="data/config.json";angular.module("app").factory("Config",function(File,Page,$http){function _configWrap(config){return $.extend({title:"My Blog",dateFormat:"YYYY-MM-DD HH:mm"},config||{})}var _config,Config=function(){};return Config.get=function(forceRefresh){if(Page.local){if(!_config||forceRefresh)try{_config=_configWrap(JSON.parse(File.read(_configPath,!0)))}catch(err){_config=_configWrap()}}else _config||(_config=_configWrap(),$http.get(_configPath,{params:{_:Math.random()}}).then(function(data){_config=_configWrap(data.data)}));return _config},Config.save=function(config){return config&&(_config=config),File.write(_configPath,JSON.stringify(_config,null,"	"))},Config})}(),function(){angular.module("app").factory("File",function($q){var File=function(){};return File.path=function(path){var FS=require("fs"),PATH=require("path"),_rootPath="";return FS.existsSync("index.html")||(_rootPath=process.execPath.replace(/[^\\\/]+\.exe$/,"")),PATH.normalize(_rootPath+path)},File.assumeFolder=function(path){var FS=require("fs"),PATH=require("path");path=PATH.normalize(path),FS.existsSync(path)||(File.assumeFolder(PATH.dirname(path)),FS.mkdirSync(path))},File.write=function(path,data){var FS=require("fs"),PATH=require("path"),_deferred=$q.defer();return path=PATH.normalize(path),File.assumeFolder(PATH.dirname(path)),FS.writeFile(path,data,"utf8",function(err){err?_deferred.reject(err):_deferred.resolve()}),_deferred.promise},File.read=function(path,sync){var FS=require("fs"),PATH=require("path"),_deferred=$q.defer();return path=PATH.normalize(path),sync?FS.readFileSync(path,"utf8"):(FS.readFile(path,"utf8",function(err,data){err?_deferred.reject(err):_deferred.resolve(data)}),_deferred.promise)},File.list=function(path){var FS=require("fs"),PATH=require("path"),_deferred=$q.defer();return path=PATH.normalize(path),FS.readdir(path,function(err,list){err?_deferred.reject(err):_deferred.resolve(list)}),_deferred.promise},File.copy=function(src,tgt){var srcFile,tgtFile,FS=require("fs"),_deferred=$q.defer(),_folder=tgt.match(/(.*)[\\\/].*/)[1];return File.assumeFolder(_folder),srcFile=FS.createReadStream(src),tgtFile=FS.createWriteStream(tgt),srcFile.on("error",function(err){_deferred.reject(err)}),tgtFile.on("error",function(err){_deferred.reject(err)}),tgtFile.on("close",function(){_deferred.resolve(tgt)}),srcFile.pipe(tgtFile),_deferred.promise},File})}(),function(){angular.module("app").factory("Page",function(){var _origin={title:"",subTitle:"",hideTitle:!1,menu:[]},Page={local:!!window.require};return Page.reset=function(){$.extend(Page,_origin)},Page.reset(),Page})}(),function(){var blogCtrl=angular.module("blogCtrl",["ngRoute","ui.bootstrap"]);blogCtrl.controller("listCtrl",function($scope,Page,Blog){Page.title="Home",$scope.tag="",$scope.setTag=function(tag,force){force?$scope.tag=tag:$scope.tag=$scope.tag===tag?"":tag,$("#tags").collapse("show")},$scope.articles=function(){var _list=Blog.list();return $scope.tag?_list.tags[$scope.tag]:_list.articles}}),blogCtrl.controller("blogCtrl",function($http,$scope,$routeParams,Page,Blog,Config){Page.hideTitle=!0,$http.get("data/articles/"+$routeParams.createTime+".json",{params:{_:Math.random()}}).then(function(data){$scope.blog=data.data,$scope.date=new moment($scope.blog.createTime).format(Config.get().dateFormat);var md=new Remarkable({html:!0,xhtmlOut:!1,breaks:!1,langPrefix:"language-",linkify:!1,typographer:!1});$("#article .article-cntr").html(md.render($scope.blog.content)),$("#article .article-cntr table").addClass("table table-bordered")},function(){$.dialog({title:"OPS",content:"Can't load blog."})}),$scope["delete"]=function(){$.dialog({title:"Delete Confirm",content:"Are you sure to delete this article?",confirm:!0},function(ret){ret&&Blog["delete"]($routeParams.createTime).then(function(){$.dialog({title:"Delete success",content:"Delete success. Close dialog to go to the home page."},function(){location.href="#/home"})},function(){$.dialog({title:"Delete failed",content:"Unknown exception for deleting."})})})}}),blogCtrl.controller("createCtrl",function($scope,$routeParams,Page,Blog,Asset){function updateMD(){$("#overview .article-cntr").html(md.render($scope.blog.content)),$("#overview .article-cntr table").addClass("table table-bordered")}function save(){var _tags={},_thumbnail=$scope.blog.content.match(/^!\[[^\]]*]\(([^\)]*)(\s+"[^"]*")?\)/)[1];$.each($scope.tags.split(/\s*,\s*/),function(i,tag){_tags[tag]=tag}),$scope.blog.tags=$.map(_tags,function(tag){return tag}),$scope.blog.createTime=$scope.blog.createTime||+new Date,$scope.blog.thumbnail=_thumbnail,Blog.save($scope.blog).then(function(){$.dialog({title:"Success",content:"Save complete! Go to home page?",confirm:!0},function(ret){ret&&(location.href="#/home")})},function(err){$.dialog({title:"OPS",content:"Save error: "+err})})}function saveDisabled(){return!$scope.blog.title||!$scope.blog.content}var _refreshMD_id,$win=$(window);Page.title="Create",Page.hideTitle=!0,Page.menu=[{name:"Save",func:save,disabled:saveDisabled}],Asset.list(!0),$scope.resView=!1,$scope.tags="",$scope.blog={content:""},$routeParams.createTime&&Blog.fetch($routeParams.createTime).then(function(blog){$scope.blog=blog,$scope.tags=($scope.blog.tags||[]).join(","),updateMD()}),$scope.isImage=function(name){return/\.(jpg|jpeg|bmp|png|gif)/i.test(name)},$scope.timeDesc=function(itemName){var _moment=new moment(Number(itemName.substr(0,13)));return _moment.toString()},$scope.selectItem=function(item){$scope.isImage(item)?$scope.blog.content+=($scope.blog.content?"\n":"")+"![](data/assets/"+item+")":$scope.blog.content+=($scope.blog.content?"\n":"")+item,updateMD()},$scope.deleteAsset=function(item){$.dialog({title:"Delete Confirm",content:"Do you want to delete '"+item+"'?",confirm:!0},function(ret){ret&&(Asset["delete"](item),$scope.$apply())})};var md=new Remarkable({html:!0,xhtmlOut:!1,breaks:!1,langPrefix:"language-",linkify:!1,typographer:!1});$scope.update=function(){clearTimeout(_refreshMD_id),_refreshMD_id=setTimeout(updateMD,200)},$("#editArticle").on("drop",function(event){var files=event.originalEvent.dataTransfer.files;if(files.length)event.preventDefault(),event.stopPropagation(),Asset.upload(files).then(function(list){Asset.list(!0),$.each(list,function(i,file){$scope.blog.content+=($scope.blog.content?"\n":"")+"![](data/assets/"+file.name+")"}),updateMD()});else{var content=event.originalEvent.dataTransfer.getData("Text");$scope.isImage(content)&&(event.preventDefault(),event.stopPropagation(),$scope.blog.content+=($scope.blog.content?"\n":"")+"![]("+content+")",$scope.$apply(),updateMD())}}),$scope.resize=function(delay){$("body").addClass("lockSidebar"),setTimeout(function(){var $article=$("#editArticle"),$overview=$("#overview .article-cntr"),$resView=$("#resView");$article.css("min-height",$win.height()-$article.offset().top-15),$overview.outerHeight($win.height()-($overview.offset()||{top:0}).top-25),$resView.outerHeight($win.height()-($resView.offset()||{top:0}).top-15),$("body").removeClass("lockSidebar")},delay)},$win.on("resize.edit",$scope.resize),$scope.resize(100),$scope.$on("$destroy",function(){$win.off("resize.edit")})})}(),function(){var configCtrl=angular.module("configCtrl",["ngRoute","ui.bootstrap"]);configCtrl.controller("configCommonCtrl",function($scope,Page,Config){Page.title="Config",$scope.config=$.extend({},Config.get(),!0),$scope.save=function(){Config.save($scope.config).then(function(){$.dialog({title:"Success",content:"Save successfully!"})},function(err){$.dialog({title:"OPS",content:"Save failed! "+err})})}})}();